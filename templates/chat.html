<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чат-комната: {{ room_name }}</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Настройка шрифта Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Стили для скроллбара в области сообщений */
        .chat-area::-webkit-scrollbar {
            width: 8px;
        }
        .chat-area::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* gray-300 */
            border-radius: 4px;
        }
        .chat-area::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8; /* gray-400 */
        }
        /* Плавные переходы для интерактивных элементов */
        .transition-colors {
            transition-property: background-color, border-color, color, fill, stroke;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
    </style>
    <!-- Подключение Socket.IO клиента -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="min-h-screen flex flex-col antialiased">

    <!-- Основной контейнер чата -->
    <div class="flex flex-col flex-grow w-full max-w-4xl mx-auto shadow-xl rounded-xl bg-white my-8 overflow-hidden">

        <!-- Шапка/Заголовок чата -->
        <header class="p-4 bg-indigo-600 text-white shadow-md flex justify-between items-center rounded-t-xl">
            <h1 class="text-2xl font-bold">
                Комната: <span id="room-name-display">{{ room_name }}</span>
            </h1>
            <div class="flex items-center space-x-4">
                <span class="text-sm opacity-90">Ваш ID: <span id="user-id-display">{{ user_id }}</span></span>
                <a href="{{ url_for('logout') }}" class="bg-red-500 hover:bg-red-700 text-white font-semibold py-1.5 px-4 rounded-lg transition-colors shadow-md">
                    Выйти
                </a>
            </div>
        </header>

        <!-- Область сообщений (Скроллируемая) -->
        <div id="messages" class="chat-area flex-grow p-6 space-y-4 overflow-y-auto h-[70vh]">
            <!-- Здесь будут динамически загружаться и добавляться сообщения -->

            <!-- Пример системного сообщения -->
            <div id="status-container" class="text-center text-sm text-gray-500 italic py-2">
                Подключение к чату...
            </div>
        </div>

        <!-- Форма ввода сообщения -->
        <div class="p-4 bg-gray-100 border-t border-gray-200 rounded-b-xl">
            <form id="send-form" class="flex space-x-3">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Напишите сообщение..."
                    autocomplete="off"
                    maxlength="500"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                >
                <button
                    type="submit"
                    id="send-button"
                    class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors shadow-md disabled:bg-gray-400"
                    disabled
                >
                    Отправить
                </button>
            </form>
            <div id="typing-indicator" class="mt-2 text-sm text-gray-500 italic hidden">
                ... кто-то печатает
            </div>
        </div>

    </div>

    <!-- JavaScript логика -->
    <script>
        // Инициализация переменных, используя данные из Flask
        const ROOM_NAME = document.getElementById('room-name-display').textContent.trim();
        const USER_ID = document.getElementById('user-id-display').textContent.trim();
        const messagesContainer = document.getElementById('messages');
        const sendForm = document.getElementById('send-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');

        // Глобальная переменная для Socket.IO
        let socket;

        // Переменная для управления таймером печати
        let typingTimer = null;
        const TYPING_TIMEOUT = 2000; // 2 секунды

        // --- 1. Вспомогательные функции ---

        /**
         * Добавляет сообщение в контейнер чата.
         * @param {string} content - Содержимое сообщения.
         * @param {string} senderName - Имя отправителя.
         * @param {string} senderId - ID отправителя.
         * @param {string} timestamp - Время отправки.
         * @param {boolean} isSystem - Является ли сообщение системным.
         */
        function addMessage(content, senderName, senderId, timestamp, isSystem = false) {
            // Удаляем индикатор "Подключение к чату..." после получения первого сообщения
            const statusDiv = document.getElementById('status-container');
            if (statusDiv) statusDiv.remove();

            const messageDiv = document.createElement('div');
            const isMine = senderId === USER_ID && !isSystem;

            if (isSystem) {
                // Системное сообщение
                messageDiv.className = "text-center text-sm text-gray-500 italic py-1";
                messageDiv.innerHTML = `— ${content} —`;
            } else {
                // Пользовательское сообщение
                const alignment = isMine ? 'justify-end' : 'justify-start';
                const bubbleColor = isMine ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800';
                const nameColor = isMine ? 'text-indigo-600 font-semibold' : 'text-gray-600 font-medium';

                messageDiv.className = `flex ${alignment} w-full`;
                messageDiv.innerHTML = `
                    <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-md ${bubbleColor}">
                        <div class="text-xs ${nameColor} mb-1 ${isMine ? 'text-right' : 'text-left'}">
                            ${isMine ? 'Вы' : senderName}
                        </div>
                        <p class="whitespace-pre-wrap">${content}</p>
                        <span class="text-xs mt-1 block ${isMine ? 'text-indigo-100 text-right' : 'text-gray-500 text-left'}">
                            ${timestamp}
                        </span>
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        /**
         * Прокручивает контейнер сообщений до конца.
         */
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }


        // --- 2. Логика Socket.IO ---

        function connectSocket() {
            // Проверяем, существует ли socket.io, чтобы избежать ошибок
            if (typeof io === 'undefined') {
                addMessage("Ошибка: Socket.IO клиент не загружен. Проверьте подключение.", "Система", "system", new Date().toLocaleTimeString(), true);
                return;
            }

            // Указываем, что нужно подключаться к текущему хосту
            socket = io();

            // --- ОБРАБОТЧИКИ СОБЫТИЙ СОКЕТА ---

            // 2.1. Подключение
            socket.on('connect', () => {
                console.log('Подключено к серверу Socket.IO.');
                sendButton.disabled = false;
                messageInput.disabled = false;

                // Запрос на присоединение к комнате и получение истории
                socket.emit('join', { room: ROOM_NAME });
                addMessage(`Вы вошли в комнату: ${ROOM_NAME}`, "Система", "system", new Date().toLocaleTimeString(), true);
            });

            // 2.2. Отключение
            socket.on('disconnect', () => {
                console.log('Отключено от сервера Socket.IO.');
                sendButton.disabled = true;
                messageInput.disabled = true;
                addMessage("Потеряно соединение с сервером.", "Система", "system", new Date().toLocaleTimeString(), true);
            });

            // 2.3. Получение истории сообщений (при входе в комнату)
            socket.on('message_history', (data) => {
                messagesContainer.innerHTML = ''; // Очищаем контейнер перед загрузкой истории

                if (data.history && data.history.length > 0) {
                    data.history.forEach(msg => {
                        addMessage(msg.content, msg.user_name, msg.user_id, msg.timestamp);
                    });
                } else {
                     document.getElementById('messages').innerHTML = '<div id="status-container" class="text-center text-sm text-gray-500 italic py-2">Сообщений пока нет. Будьте первым!</div>';
                }

                // Добавляем системное сообщение после истории
                addMessage(`Ваше имя: ${data.user_name}`, "Система", "system", new Date().toLocaleTimeString(), true);
                scrollToBottom();
            });

            // 2.4. Получение нового сообщения
            socket.on('new_message', (data) => {
                // Скрываем индикатор печати, если сообщение пришло от печатающего
                if (data.user_id !== USER_ID) {
                    hideTypingIndicator(data.user_name);
                }
                addMessage(data.content, data.user_name, data.user_id, data.timestamp);
            });

            // 2.5. Получение системного сообщения
            socket.on('status_message', (data) => {
                addMessage(data.msg, "Система", "system", new Date().toLocaleTimeString(), true);
            });

            // 2.6. Получение информации о печати
            socket.on('typing_status', (data) => {
                if (data.user_id !== USER_ID) {
                    showTypingIndicator(data.user_name);
                }
            });

            // 2.7. Ошибка (например, превышение лимита символов)
            socket.on('error_message', (data) => {
                addMessage(`Ошибка: ${data.msg}`, "Система", "system", new Date().toLocaleTimeString(), true);
            });
        }


        // --- 3. Логика отправки и печати ---

        /**
         * Обработчик отправки формы.
         */
        sendForm.onsubmit = function(e) {
            e.preventDefault();
            const message = messageInput.value.trim();

            if (message && socket && socket.connected) {
                socket.emit('send_message', { content: message });
                messageInput.value = ''; // Очищаем поле ввода
                // Сбрасываем таймер и отправляем сигнал 'stop_typing' после отправки
                clearTimeout(typingTimer);
                typingTimer = null;
                socket.emit('stop_typing');
            }
        };

        /**
         * Обработчик события ввода (для индикатора печати).
         */
        messageInput.oninput = function() {
            // Если таймер не установлен, отправляем сигнал 'start_typing'
            if (!typingTimer && socket && socket.connected) {
                socket.emit('start_typing');
            }

            // Сбрасываем предыдущий таймер
            clearTimeout(typingTimer);

            // Устанавливаем новый таймер
            typingTimer = setTimeout(() => {
                // По истечении таймаута отправляем сигнал 'stop_typing'
                if (socket && socket.connected) {
                    socket.emit('stop_typing');
                }
                typingTimer = null;
            }, TYPING_TIMEOUT);
        };

        // --- 4. Логика индикатора печати ---
        let typingUsers = new Set();
        let indicatorTimeout = null;

        /**
         * Показывает, что пользователь печатает.
         * @param {string} userName - Имя печатающего пользователя.
         */
        function showTypingIndicator(userName) {
            typingUsers.add(userName);
            updateTypingIndicator();

            // Сбрасываем предыдущий таймер, если он был
            clearTimeout(indicatorTimeout);

            // Устанавливаем таймер для автоматического скрытия индикатора, если
            // в течение 3 секунд не пришло новое событие 'typing_status'
            indicatorTimeout = setTimeout(() => {
                typingUsers.delete(userName);
                updateTypingIndicator();
            }, 3000); // 3 секунды
        }

        /**
         * Скрывает, что пользователь печатает.
         * @param {string} userName - Имя пользователя, который перестал печатать.
         */
        function hideTypingIndicator(userName) {
            typingUsers.delete(userName);
            updateTypingIndicator();
        }

        /**
         * Обновляет текст индикатора печати.
         */
        function updateTypingIndicator() {
            if (typingUsers.size > 0) {
                const usersArray = Array.from(typingUsers);
                let text = '';
                if (usersArray.length === 1) {
                    text = `${usersArray[0]} печатает...`;
                } else if (usersArray.length > 1) {
                    text = `Несколько человек печатают...`;
                }
                typingIndicator.textContent = text;
                typingIndicator.classList.remove('hidden');
            } else {
                typingIndicator.classList.add('hidden');
            }
        }


        // --- 5. Запуск приложения ---
        window.onload = function() {
            connectSocket();
        };

    </script>

</body>
</html>