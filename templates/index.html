<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç-–∫–æ–º–Ω–∞—Ç–∞: {{ room_code }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* –°—Ç–∏–ª—å –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
        body { background-color: #f0f2f5; }
        .chat-container {
            max-width: 700px;
            margin: 0 auto;
            height: 90vh; 
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .chat-window {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .input-area {
            padding: 1rem;
            border-top: 1px solid #dee2e6;
            background-color: #f8f9fa;
        }
        /* –°—Ç–∏–ª—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Å–ª–µ–≤–∞) */
        .bg-light { 
            background-color: #e9e9eb !important; 
            max-width: 80%;
            margin-right: auto;
        }
        /* –°—Ç–∏–ª—å –¥–ª—è –≤–∞—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Å–ø—Ä–∞–≤–∞) */
        .bg-primary { 
            background-color: #007bff !important; 
            max-width: 80%;
            margin-left: auto;
        }
        /* –°—Ç–∏–ª—å –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
        .system-message {
            text-align: center;
            font-size: 0.8rem;
            color: #6c757d;
            margin: 0.5rem 0;
        }
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ */
        #typing_indicator {
            min-height: 1.5em; 
            padding: 0 1rem;
        }
    </style>
</head>
<body>

<div class="chat-container my-3">
    <div class="p-3 bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">üîë –ö–æ–º–Ω–∞—Ç–∞: {{ room_code }}</h5>
            <div>
                <span class="me-2 fw-bold">{{ username }}</span>
                <a href="{{ url_for('choose_room') }}" class="btn btn-warning btn-sm me-2">–°–º–µ–Ω–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É</a>
                <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">–í—ã—Ö–æ–¥</a>
            </div>
        </div>
    </div>
    
    <div id="messages" class="chat-window">
        {% for message in history %}
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    addMessage('{{ message.sender_name }}', '{{ message.text }}', '{{ message.timestamp.strftime("%H:%M:%S") }}');
                });
            </script>
        {% endfor %}
    </div>
    
    <div id="typing_indicator" class="text-secondary small">
    </div>

    <div class="input-area">
        <div class="input-group">
            <input type="text" id="message_input" class="form-control" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ">
            <button class="btn btn-success" type="button" id="send_button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
<script>
    const socket = io();
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message_input');
    const sendButton = document.getElementById('send_button');
    const typingIndicator = document.getElementById('typing_indicator');
    
    // !!! –ù–û–í–û–ï: –ö–û–î –ö–û–ú–ù–ê–¢–´ –ò–ó FLASK !!!
    const roomCode = '{{ room_code }}'; 
    const currentUsername = '{{ username }}'; 


    // --- 1. –õ–û–ì–ò–ö–ê –ü–†–ò–°–û–ï–î–ò–ù–ï–ù–ò–Ø –ö –ö–û–ú–ù–ê–¢–ï ---
    socket.on('connect', function() {
        console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ SocketIO. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è—é—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ:', roomCode);
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä Flask
        socket.emit('join', {room: roomCode});
    });


    // --- 2. –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π ---
    function addMessage(sender, text, timestamp) {
        // –ï—Å–ª–∏ —ç—Ç–æ –°–ò–°–¢–ï–ú–ù–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (sender === '–°–∏—Å—Ç–µ–º–∞') {
            const systemElement = document.createElement('div');
            systemElement.classList.add('system-message');
            systemElement.textContent = text;
            messagesDiv.appendChild(systemElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return;
        }

        // –ï—Å–ª–∏ —ç—Ç–æ –û–ë–´–ß–ù–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ
        const messageElement = document.createElement('div');
        messageElement.classList.add('p-2', 'rounded', 'mb-2');
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
        const time = timestamp || new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        
        if (sender === currentUsername) {
            // –°–æ–æ–±—â–µ–Ω–∏–µ –¢–ï–ö–£–©–ï–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–°–ø—Ä–∞–≤–∞, —Å–∏–Ω–∏–π —Ñ–æ–Ω)
            messageElement.classList.add('bg-primary', 'text-white', 'ms-auto');
            messageElement.innerHTML = `
                <p class="mb-0">${text}</p>
                <small class="text-white-50 float-end">${time}</small>
            `;
        } else {
            // –°–æ–æ–±—â–µ–Ω–∏–µ –î–†–£–ì–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–°–ª–µ–≤–∞, —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω)
            messageElement.classList.add('bg-light', 'text-dark', 'me-auto');
            messageElement.innerHTML = `
                <small class="fw-bold text-primary">${sender}</small>
                <p class="mb-0">${text}</p>
                <small class="text-secondary float-end">${time}</small>
            `;
        }
        
        messagesDiv.appendChild(messageElement);
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // --- 3. –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    sendButton.onclick = function() {
        sendMessage();
    };

    messageInput.onkeypress = function(e) {
        if (e.key === 'Enter') {
            sendMessage();
            e.preventDefault();
        }
    };
    
    function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
            // !!! –ù–ï–¢ roomCode –≤ emit, —Ç–∞–∫ –∫–∞–∫ —Å–µ—Ä–≤–µ—Ä –∑–Ω–∞–µ—Ç –∫–æ–º–Ω–∞—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è !!!
            socket.emit('message_sent', { message: message }); 
            messageInput.value = '';
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    socket.on('new_message', function(data) {
        addMessage(data.sender, data.text, data.timestamp);
    });
    
    // --- 4. –õ–æ–≥–∏–∫–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏ (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    const typingUsers = new Set();
    let typingTimer;
    let isTyping = false;
    
    messageInput.addEventListener('input', () => {
        if (!isTyping) {
            isTyping = true;
            socket.emit('typing_start');
        }
        
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            isTyping = false;
            socket.emit('typing_stop');
        }, 1500);
    });

    function updateTypingIndicator() {
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—á–∞—Ç–∞—é—Ç, –∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const othersTyping = Array.from(typingUsers).filter(user => user !== currentUsername); 

        if (othersTyping.length > 0) {
            const list = othersTyping.join(', ');
            typingIndicator.textContent = `${list} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
        } else {
            typingIndicator.textContent = '';
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–∞ –æ –ø–µ—á–∞—Ç–∏
    socket.on('typing_update', function(data) {
        if (data.is_typing) {
            typingUsers.add(data.username);
        } else {
            typingUsers.delete(data.username);
        }
        updateTypingIndicator();
    });

</script>
</body>
</html>